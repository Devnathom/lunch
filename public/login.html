<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>เข้าสู่ระบบ - ระบบรายงานอาหารกลางวัน</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{font-family:'Prompt',sans-serif}
body{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(135deg,#0d47a1 0%,#1565c0 30%,#1976d2 60%,#42a5f5 100%)}
.login-card{max-width:420px;width:100%;border:none;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.login-logo{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#1565c0,#0d47a1);display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;box-shadow:0 4px 15px rgba(21,101,192,.4)}
.form-control{border-radius:12px;padding:.7rem 1rem;border:1.5px solid #e0e0e0;font-size:.95rem}
.form-control:focus{border-color:#1565c0;box-shadow:0 0 0 .2rem rgba(21,101,192,.15)}
.btn-login{background:linear-gradient(135deg,#1565c0,#0d47a1);border:none;border-radius:12px;padding:.7rem;font-size:1rem;font-weight:600;letter-spacing:.3px;transition:all .2s}
.btn-login:hover{background:linear-gradient(135deg,#0d47a1,#002171);transform:translateY(-1px);box-shadow:0 4px 12px rgba(13,71,161,.4)}
.input-group-text{background:#f8f9fa;border:1.5px solid #e0e0e0;border-right:none;border-radius:12px 0 0 12px;color:#757575}
.input-group .form-control{border-left:none;border-radius:0 12px 12px 0}
.toggle-pass{cursor:pointer;border-left:none;border-radius:0 12px 12px 0;background:#f8f9fa;border:1.5px solid #e0e0e0;color:#757575}
.toggle-pass:hover{color:#1565c0}
.alert{border-radius:12px;font-size:.9rem}
.caps-warn{display:none;color:#ef6c00;font-size:.8rem;margin-top:.25rem}
</style>
</head>
<body>

<div class="container d-flex align-items-center justify-content-center flex-grow-1 py-4">
  <div class="login-card card">
    <div class="card-body p-4 p-md-5">
      <div class="login-logo">
        <i class="bi bi-shield-lock-fill text-white fs-1"></i>
      </div>
      <h4 class="text-center fw-bold mb-1">เข้าสู่ระบบ</h4>
      <p class="text-center text-muted small mb-4">ระบบรายงานอาหารกลางวัน</p>

      <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

      <form id="loginForm" onsubmit="handleLogin(event)" novalidate>
        <div class="mb-3">
          <label class="form-label small fw-medium">ชื่อผู้ใช้</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-person"></i></span>
            <input type="text" class="form-control" id="username" placeholder="กรอกชื่อผู้ใช้" required autocomplete="username" autofocus>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label small fw-medium">รหัสผ่าน</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input type="password" class="form-control" id="password" placeholder="กรอกรหัสผ่าน" required autocomplete="current-password" onkeyup="checkCaps(event)">
            <button type="button" class="toggle-pass" onclick="togglePassword()"><i class="bi bi-eye" id="eyeIcon"></i></button>
          </div>
          <div class="caps-warn" id="capsWarn"><i class="bi bi-exclamation-triangle"></i> Caps Lock เปิดอยู่</div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="rememberMe">
            <label class="form-check-label small" for="rememberMe">จดจำฉัน</label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-login w-100 mb-3" id="btnLogin">
          <span id="btnText"><i class="bi bi-box-arrow-in-right"></i> เข้าสู่ระบบ</span>
          <span id="btnSpinner" class="d-none"><span class="spinner-border spinner-border-sm me-1"></span> กำลังเข้าสู่ระบบ...</span>
        </button>
      </form>

      <div class="text-center">
        <a href="/" class="text-decoration-none small text-muted"><i class="bi bi-arrow-left"></i> กลับหน้าหลัก</a>
      </div>
    </div>
  </div>
</div>

<footer class="text-center py-3 text-white-50 small">
  &copy; <script>document.write(new Date().getFullYear()+543)</script> ระบบรายงานอาหารกลางวัน
</footer>

<script>
// Check if already logged in
const savedToken = localStorage.getItem('auth_token');
if (savedToken) {
  fetch('/api/auth.php?action=me', { headers: { 'Authorization': 'Bearer ' + savedToken } })
    .then(r => r.json())
    .then(d => { if (d.user) window.location.href = '/app.html'; })
    .catch(() => {});
}

function togglePassword() {
  const p = document.getElementById('password');
  const icon = document.getElementById('eyeIcon');
  if (p.type === 'password') { p.type = 'text'; icon.className = 'bi bi-eye-slash'; }
  else { p.type = 'password'; icon.className = 'bi bi-eye'; }
}

function checkCaps(e) {
  document.getElementById('capsWarn').style.display = e.getModifierState && e.getModifierState('CapsLock') ? 'block' : 'none';
}

async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const alertBox = document.getElementById('alertBox');
  alertBox.classList.add('d-none');

  if (!username || !password) {
    alertBox.textContent = 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน';
    alertBox.classList.remove('d-none');
    return;
  }

  document.getElementById('btnText').classList.add('d-none');
  document.getElementById('btnSpinner').classList.remove('d-none');
  document.getElementById('btnLogin').disabled = true;

  try {
    const res = await fetch('/api/auth.php?action=login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();

    if (data.success) {
      localStorage.setItem('auth_token', data.token);
      localStorage.setItem('auth_user', JSON.stringify(data.user));
      if (data.school) localStorage.setItem('auth_school', JSON.stringify(data.school));
      window.location.href = '/app.html';
    } else {
      alertBox.innerHTML = '<i class="bi bi-exclamation-circle"></i> ' + data.message;
      alertBox.classList.remove('d-none');
      document.getElementById('password').value = '';
      document.getElementById('password').focus();
    }
  } catch (err) {
    alertBox.textContent = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
    alertBox.classList.remove('d-none');
  }

  document.getElementById('btnText').classList.remove('d-none');
  document.getElementById('btnSpinner').classList.add('d-none');
  document.getElementById('btnLogin').disabled = false;
}
</script>
</body>
</html>
